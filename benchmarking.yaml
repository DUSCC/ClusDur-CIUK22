---
  - name: Wait 2 minutes for target connection to become reachable
    wait_for_connection:
      timeout: 120

  - hosts: all
    become: true
    remote_user: centos
    tasks:
    - name: Install git
      yum:
        name: git
        state: latest

    - name: Install gcc and c++ extension
      yum:
        name:
          - gcc
          - gcc-c++
        state: latest

    - name: Install make
      yum:
        name: make
        state: latest

    - name: Install wget
      yum:
        name: wget
        state: latest

    - name: Install openMPI
      yum:
        name:
          - openmpi
          - openmpi-devel
        state: latest

    - name: Create results directory
      file:
        path: /home/centos/results
        state: directory

    - name: Copy required HPL files to remote
      copy:
        src: "{{ item }}"
        dest: /home/centos/
        mode: "0644"
      with_items:
        - ./scripts/HPL1.dat
        - ./scripts/HPL128.dat
        - ./scripts/Make.intel64

    - name: Execute HPL benchmark
      script: ./scripts/hpl.sh
      register: hpl_out

    - name: HPL debug
      debug: var=hpl_out.stdout_lines
